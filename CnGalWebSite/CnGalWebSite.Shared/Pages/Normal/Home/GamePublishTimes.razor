@page "/times"
@page "/gamepublishtimelist"

@inject IHttpService _httpService

@inject IJSRuntime JS
@inject IDataCacheService _dataCacheService
@inject NavigationManager NavigationManager
@inject IPageModelCatche<List<EntryInforTipViewModel>> _pageModelCatche

<CnGalWebSite.Shared.MasaComponent.Shared.Cards.TitleTip Title="@PageTitle" Description="@PageDescription"/>

<style>
    .row {
        flex: 0;
    }
</style>
<div>
    @if (isReady == false)
    {
        <CnGalWebSite.Components.Progressings.ProgressingCard Page />
    }
    else
    {
        <MDCard Class="ps-4 pe-4 mb-4">
            <div style="display: flex;flex-direction: column;align-items: center;align-content: center;" class="pt-4">
                <div class="title-large mb-3">@PageTitle</div>
                <div class="d-flex flex-wrap gap-2">
                    <MButtonGroup Tile Group Value="(int)Type" ValueChanged="OnDisplayTypeChanged"  Color="primary" Dense>
                        <MButton  Value="@((int)PublishGamesDisplayType.CardList)">
                            <MIcon Left>@IconType.Catalogs.ToIconString()</MIcon>
                            卡片列表
                        </MButton>
                        <MButton  Value="@((int)PublishGamesDisplayType.Timeline)">
                            <MIcon Left>@IconType.Timeline.ToIconString()</MIcon>
                            时间线
                        </MButton>
                    </MButtonGroup>
                    <MButtonGroup Tile Group Value="mode" ValueChanged="OnDataModeChanged" Color="primary" Dense>
                        <MButton  Value="0">
                            <MIcon Left>@IconType.Official.ToIconString()</MIcon>
                            正式版
                        </MButton>
                        <MButton  Value="1">
                            <MIcon Left>@IconType.Demo.ToIconString()</MIcon>
                            试玩版
                        </MButton>
                    </MButtonGroup>
                </div>
            </div>
            <div style="display: flex; align-items: center; justify-content: center;">
                @if (Type == PublishGamesDisplayType.CardList)
                {
                    <CnGalWebSite.Components.Buttons.MasaButton Text="上个月" Icon="mdi-arrow-left-thick" TextStyle OnClick="OnClickLeft" />
                    <div style="max-width:170px" class="ps-2 pe-2">
                        <CnGalWebSite.Shared.MasaComponent.Shared.Components.MasaMonthPick Date="Date" DateChanged="DateChanged" />
                    </div>
                    <CnGalWebSite.Components.Buttons.MasaButton Text="下个月" Icon="mdi-arrow-right-thick" TextStyle OnClick="OnClickRight" />
                }
                else
                {
                    <div style="max-width: 180px" class="mb-4">
                        <CnGalWebSite.Components.Inputs.MasaDatePicker ShowTime="false" Value="After" ValueChanged="AfterChanged" />

                    </div>
                    <span class="ms-4 me-4">  ~  </span>
                    <div style="max-width: 180px" class="mb-4">
                        <CnGalWebSite.Components.Inputs.MasaDatePicker ShowTime="false" Value="Before" ValueChanged="BeforeChanged" />

                    </div>
                }
            </div>
        </MDCard>
        @if (Type == PublishGamesDisplayType.CardList)
        {
            <div>
                @foreach (var item in CardModel.OrderBy(s => s.PublishTime))
                {
                    <div class="mb-4">
                        <CnGalWebSite.Shared.MasaComponent.Shared.Cards.Search.EntryInforViewTip Model="item" ForcedShowPublishTime ShowType="false" />
                    </div>
                }
            </div>
        }
        else
        {
            if (TimelineModel.Any())
            {
                var i = 0;

                    <MTimeline Dense="_dataCacheService.IsApp||TimelineModel.Count<3">

                        @foreach (var item in TimelineModel.OrderByDescending(s => s.PublishTime))
                        {
                            <MTimelineItem Large Color="@GetColor(i)">
                                <OppositeContent>
                                    <span>@(string.IsNullOrWhiteSpace(item.PublishTimeNote) ? item.PublishTime.Value.ToString("yyyy年M月d日") : item.PublishTimeNote)</span>
                                </OppositeContent>
                                <ChildContent>
                                        <CnGalWebSite.Shared.MasaComponent.Shared.Cards.Search.EntryInforViewTip Model="item" ShowType="false" ShowDetailNumber="(_dataCacheService.IsApp||TimelineModel.Count<3)" BigCardStyle="@_dataCacheService.IsApp"/>
                                </ChildContent>
                            </MTimelineItem>


                            i = (i + 1) % 11;

                        }
                    </MTimeline>
            }

        }


        @if (isFirst == false && ((Type == PublishGamesDisplayType.CardList && CardModel.Any() == false) || (Type == PublishGamesDisplayType.Timeline && TimelineModel.Any() == false)))
        {
            <NotFoundCard  />
        }
    }
</div>

@code {
    [CascadingParameter]
    public ErrorHandler ErrorHandler { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public int Year { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public int Month { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public long BeforeTime { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public long AfterTime { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public int type { get; set; }

    [SupplyParameterFromQuery]
    [Parameter]
    public int mode { get; set; }

    public PublishGamesDisplayType Type { get; set; }

    DateOnly Date = DateOnly.FromDateTime(DateTime.Now);

    DateTime Before = DateTime.Now.AddDays(1);

    DateTime After = DateTime.Now.AddMonths(-1);

    bool isFirst = true;

    List<EntryInforTipViewModel> CardModel = new List<EntryInforTipViewModel>();
    List<PublishGamesTimelineModel> TimelineModel = new List<PublishGamesTimelineModel>();

    bool isReady = false;

    string PageTitle => mode == 1 ? "游戏试玩时间汇总" : "游戏发布时间汇总";

    string PageDescription => mode == 1 ? "可以查看每月游戏试玩日期列表" : "可以查看每月发售游戏列表";

    public string GetColor(int index)
    {
        return index switch { 0 => "red", 1 => "pink", 2 => "purple", 3 => "deep-purple", 4 => "indigo", 5 => "blue", 6 => "cyan", 7 => "teal", 8 => "green", 9 => "yellow", 10 => "orange", _ => "black" };
    }

    protected override async Task OnParametersSetAsync()
    {

        try
        {
            isFirst = true;
            mode = mode == 1 ? 1 : 0;
            Type = (PublishGamesDisplayType)type;

            if (Type == PublishGamesDisplayType.CardList)
            {
                if (Year == 0 || Month == 0 || Month > 12)
                {
                    Date = DateOnly.FromDateTime(DateTime.Now);
                }
                else
                {
                    Date = new DateOnly(Year, Month, 1);
                }

                CardModel = await _pageModelCatche.GetCache($"api/entries/GetPublishGamesByTime?year={Year}&month={Month}&mode={mode}");

            }
            else
            {
                if (AfterTime != 0)
                {
                    After = AfterTime.ToString().TransTime();
                }
                if (BeforeTime != 0)
                {
                    Before = BeforeTime.ToString().TransTime();
                }

                TimelineModel = await _dataCacheService.PublishGamesTimelineDataCatche.GetCache($"?beforeTime={BeforeTime}&aftertime={AfterTime}&mode={mode}");
            }
            isFirst = false;
            isReady = true;

        }
        catch (Exception ex)
        {
            await ErrorHandler.ProcessError(ex, "获取游戏发售时间列表失败");
        }

    }




    public void OnClickLeft()
    {
        DateChanged(Date.AddMonths(-1));

    }

    public void OnClickRight()
    {
        DateChanged(Date.AddMonths(1));

    }

    public void DateChanged(DateOnly date)
    {
        Date = date;
        Refresh();
    }

    public void BeforeChanged(DateTime date)
    {
        Before = date;
        Refresh();
    }

    public void AfterChanged(DateTime date)
    {
        After = date;
        Refresh();
    }

    public void OnDisplayTypeChanged(StringNumber value)
    {
        if (value == null)
        {
            value = (int)PublishGamesDisplayType.CardList;
        }
        Type = (PublishGamesDisplayType)value.ToInt32();
        type = value.ToInt32();
        isFirst = false;
        Refresh();
    }

    public void OnDataModeChanged(StringNumber value)
    {
        if (value == null)
        {
            value = (int)0;
        }
        mode = value.ToInt32();
        isFirst = false;
        Refresh();
    }

    public void ViewAt(int id)
    {
        NavigationManager.NavigateTo("/entries/index/" + id);
        
    }

    public void Refresh()
    {
        try
        {
            if (Type == PublishGamesDisplayType.CardList)
            {
                NavigationManager.NavigateTo(NavigationManager.GetUriWithQueryParameters(new Dictionary<string, object>
                {
                    ["year"] = Date.Year,
                    ["month"] = Date.Month,
                    ["type"] = (int)Type,
                    ["mode"] = mode,
                }));
            }
            else
            {
                NavigationManager.NavigateTo(NavigationManager.GetUriWithQueryParameters(new Dictionary<string, object>
                {
                    ["beforeTime"] = Before.ToUnixTimeMilliseconds(),
                    ["afterTime"] = After.ToUnixTimeMilliseconds(),
                    ["type"] = (int)Type,
                    ["mode"] = mode,
                }));
            }


        }
        catch
        {

        }

        
    }
}
