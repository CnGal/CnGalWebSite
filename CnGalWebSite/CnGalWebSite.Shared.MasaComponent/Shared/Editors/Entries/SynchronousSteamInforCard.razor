@inject IHttpService _httpService
@inject IFileUploadService _fileUploadService

<CnGalWebSite.Shared.MasaComponent.Shared.Components.MasaAlert Type="AlertTypes.Info" Class="mb-3" Color="secondary">
    游戏在Steam上发布？尝试 <a class="tertiary--text fw-bold" @onclick="OnClick">导入Steam信息</a>
</CnGalWebSite.Shared.MasaComponent.Shared.Components.MasaAlert>
<MDialog @bind-Value="Dialog"
         Width="600">
    <MDCard>
        <MCardTitle Class="text-h5">
            导入Steam信息
        </MCardTitle>
        <MCardText>
            自动抓取Steam商店页面的信息，请注意“制作组”和“发行商”需要根据站内信息进行修改
        </MCardText>

        <MCardText Class="pb-0">
            <MTextField @bind-Value="SteamId" Label="SteamId" Type="number" />
        </MCardText>
        <MCardActions Class="pb-6 pe-6 ps-6">
            <MSpacer></MSpacer>
            <CnGalWebSite.Components.Buttons.MasaButton Text="确定" IsAsync="true" OnClick="SynchronousSteamInfor" Icon="mdi-check" Color="success" TextStyle />
        </MCardActions>

    </MDCard>
</MDialog>

@code {
    [Parameter]
    public EditMainViewModel MainModel { get; set; }
    [Parameter]
    public EditAddInforViewModel AddInforModel { get; set; }
    [Parameter]
    public EditMainPageViewModel MainPageModel { get; set; }
    [Parameter]
    public EditImagesViewModel ImagesModel { get; set; }
    [Parameter]
    public EventCallback OnSynchronized { get; set; }

    bool Dialog { get; set; }
    string SteamId { get; set; }

    [CascadingParameter]
    public ErrorHandler ErrorHandler { get; set; }

    public void OnClick()
    {
        Dialog = true;
        StateHasChanged();
    }

    public string ClearString(string str)
    {
        return str?.Trim()?.Replace("\t", "")?.Replace("\n", "")?.Replace("\r", "");
    }

    public async Task SynchronousSteamInfor()
    {
        try
        {
            // 调用 Steam API
            var apiUrl = $"https://store.steampowered.com/api/appdetails?appids={SteamId}&l=schinese";
            var jsonContent = await (await _httpService.GetClientAsync()).GetStringAsync(apiUrl);

            using var document = JsonDocument.Parse(jsonContent);
            var root = document.RootElement;

            // 获取应用数据
            if (!root.TryGetProperty(SteamId, out var appElement))
            {
                throw new Exception("未找到 Steam 应用数据");
            }

            if (!appElement.TryGetProperty("success", out var successElement) || !successElement.GetBoolean())
            {
                throw new Exception("Steam API 返回失败");
            }

            if (!appElement.TryGetProperty("data", out var dataElement))
            {
                throw new Exception("Steam API 数据格式错误");
            }

            //游戏名
            var name = dataElement.TryGetProperty("name", out var nameElement) ? nameElement.GetString() : null;

            //主图
            var mainImage = dataElement.TryGetProperty("header_image", out var headerImageElement)
                ? headerImageElement.GetString()
                : null;

            //简介
            var briefIntroduction = dataElement.TryGetProperty("short_description", out var shortDescElement)
                ? ClearString(shortDescElement.GetString())?.Replace(" ", "")
                : null;

            //发行日期
            string timeNote = null;
            DateTime? time = null;
            if (dataElement.TryGetProperty("release_date", out var releaseDateElement))
            {
                if (releaseDateElement.TryGetProperty("date", out var dateElement))
                {
                    timeNote = dateElement.GetString();
                    if (!string.IsNullOrWhiteSpace(timeNote))
                    {
                        time = timeNote.ToDate();
                    }
                }
            }

            //开发商
            string group = null;
            if (dataElement.TryGetProperty("developers", out var developersElement) && developersElement.ValueKind == JsonValueKind.Array)
            {
                var developers = developersElement.EnumerateArray()
                    .Select(d => d.GetString())
                    .Where(d => !string.IsNullOrWhiteSpace(d))
                    .ToList();
                if (developers.Any())
                {
                    group = string.Join(", ", developers);
                }
            }

            //发行商
            string publisher = null;
            if (dataElement.TryGetProperty("publishers", out var publishersElement) && publishersElement.ValueKind == JsonValueKind.Array)
            {
                var publishers = publishersElement.EnumerateArray()
                    .Select(p => p.GetString())
                    .Where(p => !string.IsNullOrWhiteSpace(p))
                    .ToList();
                if (publishers.Any())
                {
                    publisher = string.Join(", ", publishers);
                }
            }

            //相册
            var images = new List<string>();
            if (dataElement.TryGetProperty("screenshots", out var screenshotsElement) && screenshotsElement.ValueKind == JsonValueKind.Array)
            {
                images = screenshotsElement.EnumerateArray()
                    .Select(s => s.TryGetProperty("path_full", out var pathFullElement) ? pathFullElement.GetString() : null)
                    .Where(img => !string.IsNullOrWhiteSpace(img))
                    .ToList();
            }

            //主页内容
            var mainPage = "";
            string html = null;
            if (dataElement.TryGetProperty("detailed_description", out var detailedDescElement))
            {
                html = detailedDescElement.GetString();
            }
            else if (dataElement.TryGetProperty("about_the_game", out var aboutGameElement))
            {
                html = aboutGameElement.GetString();
            }

            if (string.IsNullOrWhiteSpace(html) == false)
            {
                var converter = new ReverseMarkdown.Converter();
                mainPage = converter.Convert(html.Replace("<h2>关于这款游戏</h2>", "").Replace("<h2 class=\"bb_tag\">关于这款游戏</h2>", ""));
                mainPage += $"\n > 以上介绍转载自Steam商店 https://store.steampowered.com/app/{SteamId}";
            }

            //不覆盖原有信息的情况下同步Steam信息
            //主要信息
            if(MainModel!=null)
            {
                if (string.IsNullOrWhiteSpace(MainModel.MainPicture) && string.IsNullOrWhiteSpace(mainImage) == false)
                {
                    string result = await _fileUploadService.TransformImageAsync(mainImage);
                    if (string.IsNullOrWhiteSpace(result) == false)
                    {
                        MainModel.MainPicture = result;
                    }
                }
                if (string.IsNullOrWhiteSpace(MainModel.Name) && string.IsNullOrWhiteSpace(name) == false)
                {
                    MainModel.Name = name;
                }
                if (string.IsNullOrWhiteSpace(MainModel.DisplayName) && string.IsNullOrWhiteSpace(name) == false)
                {
                    MainModel.DisplayName = name;
                }
                if (string.IsNullOrWhiteSpace(MainModel.BriefIntroduction) && string.IsNullOrWhiteSpace(briefIntroduction) == false)
                {
                    MainModel.BriefIntroduction = briefIntroduction;
                }

            }
            //附加信息
            if(AddInforModel!=null)
            {
                if (string.IsNullOrWhiteSpace(AddInforModel.Publisher) && string.IsNullOrWhiteSpace(publisher) == false)
                {
                    AddInforModel.Publisher = publisher;
                }
                if (string.IsNullOrWhiteSpace(AddInforModel.ProductionGroup) && string.IsNullOrWhiteSpace(group) == false)
                {
                    AddInforModel.ProductionGroup = group;
                }
                if (string.IsNullOrWhiteSpace(timeNote) == false || string.IsNullOrWhiteSpace(publisher) == false || string.IsNullOrWhiteSpace(group) == false)
                {
                    var item = new EditReleaseModel
                    {
                        Link = SteamId,
                        GamePlatformTypes = new List<GamePlatformType> { GamePlatformType.Windows },
                        Name = name,
                        PublishPlatformType = PublishPlatformType.Steam,
                        Time = time == null ? null : time.Value.AddDays(1),
                        TimeNote = time == null ? timeNote : null,
                        Type = GameReleaseType.Official,
                    };

                    if (AddInforModel.Releases.Any(s => s.PublishPlatformType == item.PublishPlatformType && s.PublishPlatformName == item.PublishPlatformName && s.Link == item.Link && s.Name == item.Name) ==false)
                    {
                        AddInforModel.Releases.Add(item);
                    }

                }
            }
            //相册
            if(ImagesModel!=null)
            {
                if (images.Any())
                {
                    foreach (var item in images)
                    {
                        ImagesModel.Images.Add(new EditImageAloneModel
                        {
                            Image = await _fileUploadService.TransformImageAsync(item)
                        });
                    }
                }
                ImagesModel.Images.RemoveAll(s => string.IsNullOrWhiteSpace(s.Image));
            }
            //主页
            if(MainPageModel!=null)
            {
                if (string.IsNullOrWhiteSpace(MainPageModel.Context) && string.IsNullOrWhiteSpace(mainPage) == false)
                {
                    MainPageModel.Context = mainPage;
                }
            }

            await OnSynchronized.InvokeAsync();
            Dialog = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await ErrorHandler.ProcessError(ex, "导入Steam信息失败");
        }

    }
}
